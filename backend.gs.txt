// Google Apps Script å¾Œç«¯ä»£ç¢¼ - å°ç£å°åƒåº—è¨‚é¤ç³»çµ±
const SHEET_NAME = 'è¨‚å–®è³‡æ–™';

// Handle CORS preflight requests
function doOptions(e) {
  return ContentService.createTextOutput()
    .setMimeType(ContentService.MimeType.JSON)
    .withHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    });
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    let result;
    
    switch(action) {
      case 'getMenu':
        result = getMenu();
        break;
      case 'createOrder':
        result = createOrder(data.orderData, data.idToken);
        break;
      case 'getOrders':
        result = getOrders(data);
        break;
      case 'updateOrderStatus':
        result = updateOrderStatus(data.orderId, data.status);
        break;
      default:
        throw new Error('æœªçŸ¥çš„æ“ä½œé¡å‹');
    }
    
    return createResponse(true, result, 'æ“ä½œæˆåŠŸ');
    
  } catch (error) {
    console.error('Error:', error);
    return createResponse(false, null, error.message);
  }
}

function doGet(e) {
  const action = e.parameter.action;
  
  if (action === 'getMenu') {
    return createResponse(true, getMenu(), 'æˆåŠŸ');
  }
  
  return createResponse(false, null, 'ä¸æ”¯æ´çš„è«‹æ±‚æ–¹æ³•');
}

// å‰µå»ºçµ±ä¸€å›æ‡‰æ ¼å¼ (è™•ç† CORS)
function createResponse(success, data, message) {
  const response = {
    success: success,
    data: data,
    message: message
  };
  
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON)
    .withHeaders({'Access-Control-Allow-Origin': '*'});
}

// ç²å–ç•¶å‰ä½¿ç”¨çš„è©¦ç®—è¡¨
function getCurrentSpreadsheet() {
  try {
    return SpreadsheetApp.getActiveSpreadsheet();
  } catch (error) {
    throw new Error('è«‹ç¢ºä¿æ­¤è…³æœ¬å·²ç¶å®šåˆ° Google è©¦ç®—è¡¨');
  }
}

// ç²å–èœå–®
function getMenu() {
  try {
    const spreadsheet = getCurrentSpreadsheet();
    let sheet = spreadsheet.getSheetByName('èœå–®');
    
    if (!sheet) {
      return getDefaultMenu();
    }
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return getDefaultMenu();
    }
    
    const headers = data[0];
    
    const nameIndex = headers.indexOf('åç¨±');
    const priceIndex = headers.indexOf('åƒ¹æ ¼');
    const iconIndex = headers.indexOf('åœ–æ¨™');
    const statusIndex = headers.indexOf('ç‹€æ…‹');
    const imageIndex = headers.indexOf('åœ–ç‰‡');
    
    if (nameIndex === -1 || priceIndex === -1) {
      return getDefaultMenu();
    }
    
    const menuItems = [];
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[nameIndex] && row[priceIndex]) {
        menuItems.push({
          name: row[nameIndex].toString().trim(),
          price: parseInt(row[priceIndex]) || 0,
          icon: iconIndex !== -1 && row[iconIndex] ? row[iconIndex].toString().trim() : 'ğŸ½ï¸',
          status: statusIndex !== -1 && row[statusIndex] ? row[statusIndex].toString().trim() : 'ä¾›æ‡‰ä¸­',
          image: imageIndex !== -1 && row[imageIndex] ? row[imageIndex].toString().trim() : ''
        });
      }
    }
    
    return menuItems.length > 0 ? menuItems : getDefaultMenu();
    
  } catch (error) {
    console.error('ç²å–èœå–®éŒ¯èª¤:', error);
    return getDefaultMenu();
  }
}

// é»˜èªèœå–®
function getDefaultMenu() {
  return [
    { 
      name: 'æ»·è‚‰é£¯', 
      price: 35, 
      icon: 'ğŸš', 
      status: 'ä¾›æ‡‰ä¸­',
      image: 'https://images.unsplash.com/photo-1541519227354-08fa5d50c44d?w=400&h=300&fit=crop'
    },
    { 
      name: 'é›è‚‰é£¯', 
      price: 40, 
      icon: 'ğŸ—', 
      status: 'ä¾›æ‡‰ä¸­',
      image: 'https://images.unsplash.com/photo-1586190848861-99aa4a171e90?w=400&h=300&fit=crop'
    },
    { 
      name: 'èšµä»”ç…', 
      price: 65, 
      icon: 'ğŸ³', 
      status: 'ä¾›æ‡‰ä¸­',
      image: 'https://images.unsplash.com/photo-1563245372-f21724e3856d?w=400&h=300&fit=crop'
    },
    { 
      name: 'å¤§è…¸éºµç·š', 
      price: 50, 
      icon: 'ğŸœ', 
      status: 'ä¾›æ‡‰ä¸­',
      image: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=400&h=300&fit=crop'
    },
    { 
      name: 'çç å¥¶èŒ¶', 
      price: 45, 
      icon: 'ğŸ¥¤', 
      status: 'ä¾›æ‡‰ä¸­',
      image: 'https://images.unsplash.com/photo-1572490122747-3968b75cc699?w=400&h=300&fit=crop'
    }
  ];
}

// å‰µå»ºè¨‚å–® - ç¢ºä¿é›»è©±è™Ÿç¢¼ä¿æŒåŸæ¨£
function createOrder(orderData, idToken) {
  try {
    const spreadsheet = getCurrentSpreadsheet();
    let sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      sheet = initializeOrderSheet(spreadsheet);
    }
    
    if (!orderData.customerName || !orderData.customerPhone) {
      throw new Error('é¡§å®¢å§“åå’Œé›»è©±ç‚ºå¿…å¡«æ¬„ä½');
    }
    
    // é©—è­‰é›»è©±æ ¼å¼ä½†ä¸ä¿®æ”¹
    const phoneRegex = /^09\d{8}$/;
    if (!phoneRegex.test(orderData.customerPhone)) {
      throw new Error('é›»è©±è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼Œå¿…é ˆæ˜¯09é–‹é ­çš„10ä½æ•¸å­—');
    }
    
    const orderId = generateOrderId();
    const now = new Date();
    
    let totalAmount = 0;
    const itemsArray = [];
    
    orderData.items.forEach(item => {
      totalAmount += item.price * item.quantity;
      itemsArray.push(`${item.name} x${item.quantity}`);
    });
    
    if (orderData.deliveryAddress && orderData.deliveryAddress.trim() !== '') {
      totalAmount += 30;
    }
    
    const itemsString = itemsArray.join(', ');
    
    // ç›´æ¥ä½¿ç”¨åŸå§‹é›»è©±è™Ÿç¢¼ï¼Œä¸é€²è¡Œä»»ä½•è½‰æ›
    const rowData = [
      orderId,
      orderData.customerName,
      orderData.customerPhone, // ä¿æŒåŸæ¨£ 0936220535
      itemsString,
      totalAmount,
      new Date(orderData.pickupTime),
      orderData.deliveryAddress || '',
      orderData.notes || '',
      'pending',
      now,
      idToken || '',
      '',
      now
    ];
    
    sheet.appendRow(rowData);
    
    return {
      orderId: orderId,
      totalAmount: totalAmount,
      createdAt: now.toISOString()
    };
    
  } catch (error) {
    console.error('å‰µå»ºè¨‚å–®éŒ¯èª¤:', error);
    throw new Error('å‰µå»ºè¨‚å–®å¤±æ•—: ' + error.message);
  }
}

// åˆå§‹åŒ–è¨‚å–®è¡¨å–®
function initializeOrderSheet(spreadsheet) {
  const sheet = spreadsheet.insertSheet(SHEET_NAME);
  
  const orderHeaders = [
    'è¨‚å–®ç·¨è™Ÿ', 'é¡§å®¢å§“å', 'æ‰‹æ©Ÿè™Ÿç¢¼', 'è¨‚å–®å…§å®¹', 'ç¸½é‡‘é¡', 'å–é¤æ™‚é–“', 
    'å¤–é€åœ°å€', 'å‚™è¨»', 'è¨‚å–®ç‹€æ…‹', 'å‰µå»ºæ™‚é–“', 'LINE_IDToken', 'ç®¡ç†å“¡å‚™è¨»', 'æœ€å¾Œæ›´æ–°æ™‚é–“'
  ];
  
  sheet.getRange(1, 1, 1, orderHeaders.length).setValues([orderHeaders]);
  sheet.getRange(1, 1, 1, orderHeaders.length).setFontWeight('bold');
  sheet.setFrozenRows(1);
  
  // è¨­ç½®æ¬„ä½å¯¬åº¦
  sheet.setColumnWidth(1, 150); // è¨‚å–®ç·¨è™Ÿ
  sheet.setColumnWidth(2, 120); // é¡§å®¢å§“å
  sheet.setColumnWidth(3, 120); // æ‰‹æ©Ÿè™Ÿç¢¼
  sheet.setColumnWidth(4, 200); // è¨‚å–®å…§å®¹
  sheet.setColumnWidth(5, 80);  // ç¸½é‡‘é¡
  sheet.setColumnWidth(6, 150); // å–é¤æ™‚é–“
  sheet.setColumnWidth(7, 200); // å¤–é€åœ°å€
  sheet.setColumnWidth(8, 150); // å‚™è¨»
  sheet.setColumnWidth(9, 100); // è¨‚å–®ç‹€æ…‹
  sheet.setColumnWidth(10, 150); // å‰µå»ºæ™‚é–“
  sheet.setColumnWidth(11, 200); // LINE_IDToken
  sheet.setColumnWidth(12, 150); // ç®¡ç†å“¡å‚™è¨»
  sheet.setColumnWidth(13, 150); // æœ€å¾Œæ›´æ–°æ™‚é–“
  
  console.log('è¨‚å–®è¡¨å–®åˆå§‹åŒ–å®Œæˆ');
  return sheet;
}

// ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
function generateOrderId() {
  const now = new Date();
  const dateStr = Utilities.formatDate(now, 'Asia/Taipei', 'yyyyMMdd');
  const timeStr = Utilities.formatDate(now, 'Asia/Taipei', 'HHmmss');
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `ORDER${dateStr}${timeStr}${random}`;
}

// æ­£è¦åŒ–é›»è©±è™Ÿç¢¼ï¼šç§»é™¤é–‹é ­çš„0
function normalizePhone(phone) {
  if (!phone) return '';
  // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦ï¼Œç„¶å¾Œå¦‚æœä»¥0é–‹é ­å‰‡ç§»é™¤0
  const digitsOnly = phone.replace(/\D/g, '');
  return digitsOnly.startsWith('0') ? digitsOnly.substring(1) : digitsOnly;
}

// æŸ¥è©¢è¨‚å–® - æ”¯æ´å…©ç¨®é›»è©±æ ¼å¼
function getOrders(params) {
  try {
    const spreadsheet = getCurrentSpreadsheet();
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      return [];
    }
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return [];
    }
    
    const headers = data[0];
    
    const headerMap = {
      orderId: headers.indexOf('è¨‚å–®ç·¨è™Ÿ'),
      customerName: headers.indexOf('é¡§å®¢å§“å'),
      customerPhone: headers.indexOf('æ‰‹æ©Ÿè™Ÿç¢¼'),
      items: headers.indexOf('è¨‚å–®å…§å®¹'),
      totalAmount: headers.indexOf('ç¸½é‡‘é¡'),
      pickupTime: headers.indexOf('å–é¤æ™‚é–“'),
      deliveryAddress: headers.indexOf('å¤–é€åœ°å€'),
      notes: headers.indexOf('å‚™è¨»'),
      status: headers.indexOf('è¨‚å–®ç‹€æ…‹'),
      createdAt: headers.indexOf('å‰µå»ºæ™‚é–“'),
      idToken: headers.indexOf('LINE_IDToken'),
      adminNotes: headers.indexOf('ç®¡ç†å“¡å‚™è¨»'),
      updatedAt: headers.indexOf('æœ€å¾Œæ›´æ–°æ™‚é–“')
    };
    
    let filteredData = [];
    
    // æ­£è¦åŒ–æœå°‹çš„é›»è©±è™Ÿç¢¼
    const normalizedSearchPhone = params.customerPhone ? normalizePhone(params.customerPhone) : '';
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      let match = true;
      
      // æ—¥æœŸç¯„åœéæ¿¾
      if (params.startDate || params.endDate) {
        const createdAt = row[headerMap.createdAt];
        if (createdAt instanceof Date) {
          const rowDate = Utilities.formatDate(createdAt, 'Asia/Taipei', 'yyyy-MM-dd');
          
          if (params.startDate && rowDate < params.startDate) {
            match = false;
          }
          if (params.endDate && rowDate > params.endDate) {
            match = false;
          }
        }
      }
      
      // LINE ç”¨æˆ¶æœå°‹
      if (params.idToken && match) {
        const rowIdToken = row[headerMap.idToken] || '';
        if (rowIdToken.toString().trim() === params.idToken.toString().trim()) {
          // LINE ç”¨æˆ¶ï¼šåªéœ€è¦å§“ååŒ¹é…
          if (params.customerName) {
            const rowName = row[headerMap.customerName] ? row[headerMap.customerName].toString().trim() : '';
            const searchName = params.customerName.toString().trim();
            if (rowName !== searchName) {
              match = false;
            }
          }
        } else {
          match = false;
        }
      }
      // é LINE ç”¨æˆ¶æœå°‹ï¼ˆéœ€è¦å§“åå’Œé›»è©±åŒ¹é…ï¼‰
      else if (match && (params.customerName || params.customerPhone)) {
        // å§“åç²¾ç¢ºåŒ¹é…
        if (params.customerName) {
          const rowName = row[headerMap.customerName] ? row[headerMap.customerName].toString().trim() : '';
          const searchName = params.customerName.toString().trim();
          if (rowName !== searchName) {
            match = false;
          }
        }
        
        // é›»è©±è™Ÿç¢¼åŒ¹é… - æ”¯æ´å…©ç¨®æ ¼å¼
        if (match && params.customerPhone) {
          const rowPhone = row[headerMap.customerPhone] ? row[headerMap.customerPhone].toString().trim() : '';
          const searchPhone = params.customerPhone.toString().trim();
          
          // æ­£è¦åŒ–è³‡æ–™åº«ä¸­çš„é›»è©±è™Ÿç¢¼
          const normalizedRowPhone = normalizePhone(rowPhone);
          
          // ä¸‰ç¨®æ¯”å°æ–¹å¼ï¼š
          // 1. åŸå§‹æ¯”å° (0936220535 === 0936220535)
          // 2. æ­£è¦åŒ–æ¯”å° (936220535 === 936220535)  
          // 3. äº¤å‰æ¯”å° (0936220535 èˆ‡ 936220535)
          const exactMatch = rowPhone === searchPhone;
          const normalizedMatch = normalizedRowPhone === normalizedSearchPhone;
          const crossMatch = normalizedRowPhone === normalizePhone(searchPhone);
          
          if (!exactMatch && !normalizedMatch && !crossMatch) {
            match = false;
          }
        }
      }
      
      if (match) {
        const order = {
          orderId: row[headerMap.orderId] || '',
          customerName: row[headerMap.customerName] || '',
          customerPhone: row[headerMap.customerPhone] || '', // ä¿æŒåŸæ¨£é¡¯ç¤º
          items: row[headerMap.items] || '',
          totalAmount: parseFloat(row[headerMap.totalAmount]) || 0,
          pickupTime: row[headerMap.pickupTime] ? row[headerMap.pickupTime].toISOString() : '',
          deliveryAddress: row[headerMap.deliveryAddress] || '',
          notes: row[headerMap.notes] || '',
          status: row[headerMap.status] || 'pending',
          createdAt: row[headerMap.createdAt] ? row[headerMap.createdAt].toISOString() : '',
          adminNotes: row[headerMap.adminNotes] || '',
          updatedAt: row[headerMap.updatedAt] ? row[headerMap.updatedAt].toISOString() : ''
        };
        filteredData.push(order);
      }
    }
    
    return filteredData;
    
  } catch (error) {
    console.error('æŸ¥è©¢è¨‚å–®éŒ¯èª¤:', error);
    throw new Error('æŸ¥è©¢è¨‚å–®å¤±æ•—: ' + error.message);
  }
}

// æ›´æ–°è¨‚å–®ç‹€æ…‹
function updateOrderStatus(orderId, status) {
  if (!orderId || !status) {
    throw new Error('è¨‚å–® ID å’Œæ–°ç‹€æ…‹ç‚ºå¿…å¡«æ¬„ä½');
  }

  try {
    const spreadsheet = getCurrentSpreadsheet();
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error('æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™è¡¨');
    }

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const orderIdCol = headers.indexOf('è¨‚å–®ç·¨è™Ÿ');
    const statusCol = headers.indexOf('è¨‚å–®ç‹€æ…‹');
    const updatedAtCol = headers.indexOf('æœ€å¾Œæ›´æ–°æ™‚é–“');

    if (orderIdCol === -1 || statusCol === -1 || updatedAtCol === -1) {
      throw new Error('è¨‚å–®è³‡æ–™è¡¨æ¬„ä½ä¸å®Œæ•´ (éœ€è¦: è¨‚å–®ç·¨è™Ÿ, è¨‚å–®ç‹€æ…‹, æœ€å¾Œæ›´æ–°æ™‚é–“)');
    }

    for (let i = 1; i < data.length; i++) {
      if (data[i][orderIdCol] == orderId) { // Use '==' for potential type mismatch from Sheet
        const rowToUpdate = i + 1; // Sheet rows are 1-indexed
        sheet.getRange(rowToUpdate, statusCol + 1).setValue(status);
        const now = new Date();
        sheet.getRange(rowToUpdate, updatedAtCol + 1).setValue(now);
        
        return { orderId: orderId, status: status, updatedAt: now.toISOString() };
      }
    }

    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„è¨‚å–®: ' + orderId);

  } catch (error) {
    console.error('æ›´æ–°è¨‚å–®ç‹€æ…‹éŒ¯èª¤:', error);
    throw new Error('æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—: ' + error.message);
  }
}

// åˆå§‹åŒ–è¡¨å–®
function initializeSheets() {
  try {
    const spreadsheet = getCurrentSpreadsheet();
    
    let orderSheet = spreadsheet.getSheetByName(SHEET_NAME);
    if (!orderSheet) {
      orderSheet = initializeOrderSheet(spreadsheet);
    }
    
    let menuSheet = spreadsheet.getSheetByName('èœå–®');
    if (!menuSheet) {
      menuSheet = spreadsheet.insertSheet('èœå–®');
      const menuHeaders = ['åç¨±', 'åƒ¹æ ¼', 'åœ–æ¨™', 'ç‹€æ…‹', 'åœ–ç‰‡'];
      menuSheet.getRange(1, 1, 1, menuHeaders.length).setValues([menuHeaders]);
      menuSheet.getRange(1, 1, 1, menuHeaders.length).setFontWeight('bold');
      
      // è¨­ç½®æ¬„ä½å¯¬åº¦
      menuSheet.setColumnWidth(1, 120); // åç¨±
      menuSheet.setColumnWidth(2, 80);  // åƒ¹æ ¼
      menuSheet.setColumnWidth(3, 80);  // åœ–æ¨™
      menuSheet.setColumnWidth(4, 100); // ç‹€æ…‹
      menuSheet.setColumnWidth(5, 200); // åœ–ç‰‡
      
      const defaultMenu = getDefaultMenu();
      defaultMenu.forEach(item => {
        menuSheet.appendRow([item.name, item.price, item.icon, item.status, item.image || '']);
      });
      
      console.log('èœå–®è¡¨å–®åˆå§‹åŒ–å®Œæˆ');
    }
    
    console.log('æ‰€æœ‰è¡¨å–®åˆå§‹åŒ–å®Œæˆ');
    return 'åˆå§‹åŒ–æˆåŠŸï¼';
    
  } catch (error) {
    console.error('åˆå§‹åŒ–è¡¨å–®éŒ¯èª¤:', error);
    return 'åˆå§‹åŒ–å¤±æ•—: ' + error.message;
  }
}

// æ¸¬è©¦å‡½æ•¸
function testCreateOrder() {
  const testOrderData = {
    customerName: 'æ¸¬è©¦é¡§å®¢',
    customerPhone: '0936220535',
    items: [
      { name: 'æ»·è‚‰é£¯', price: 35, quantity: 2 },
      { name: 'çç å¥¶èŒ¶', price: 45, quantity: 1 }
    ],
    pickupTime: new Date(Date.now() + 60 * 60 * 1000).toISOString(),
    deliveryAddress: 'æ¸¬è©¦åœ°å€',
    notes: 'æ¸¬è©¦å‚™è¨»'
  };
  
  const result = createOrder(testOrderData, 'test_token');
  console.log('æ¸¬è©¦è¨‚å–®å‰µå»ºçµæœ:', result);
  return result;
}

function testGetOrders() {
  // æ¸¬è©¦æœå°‹ 0936220535
  const params1 = {
    customerName: 'æ¸¬è©¦é¡§å®¢',
    customerPhone: '0936220535',
    startDate: '2024-01-01',
    endDate: '2024-12-31'
  };
  
  // æ¸¬è©¦æœå°‹ 936220535
  const params2 = {
    customerName: 'æ¸¬è©¦é¡§å®¢',
    customerPhone: '936220535',
    startDate: '2024-01-01',
    endDate: '2024-12-31'
  };
  
  const result1 = getOrders(params1);
  const result2 = getOrders(params2);
  
  console.log('æœå°‹ 0936220535 çµæœ:', result1);
  console.log('æœå°‹ 936220535 çµæœ:', result2);
  
  return {
    searchWithZero: result1,
    searchWithoutZero: result2
  };
}

// æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™
function clearTestData() {
  try {
    const spreadsheet = getCurrentSpreadsheet();
    const sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (sheet && sheet.getLastRow() > 1) {
      sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
      console.log('æ¸¬è©¦è³‡æ–™å·²æ¸…é™¤');
    }
    
    return 'æ¸¬è©¦è³‡æ–™æ¸…é™¤å®Œæˆ';
  } catch (error) {
    console.error('æ¸…é™¤è³‡æ–™éŒ¯èª¤:', error);
    return 'æ¸…é™¤å¤±æ•—: ' + error.message;
  }
}